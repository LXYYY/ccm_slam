<?xml version="1.0"?>
<launch>
  <param name="use_sim_time" value="true"/>
  <arg name="sensor" default="xtion"/>
  <node pkg="image_transport" type="republish" name="republish_color_1" args="compressed in:=/kinect2/qhd/image_color_rect1 raw out:=/kinect2/qhd/image_color_rect1"/>
  <node pkg="image_transport" type="republish" name="republish_depth_1" args="compressed in:=/kinect2/qhd/image_depth_rect1 raw out:=/kinect2/qhd/image_depth_rect1"/>
  <arg name="dist" default="0"/>
  <arg name="frontview" default="1"/>
  <arg name="cam" default="$(find ccmslam)/conf/caminfo_$(arg sensor)_cvg.yaml"/>

  <arg if="$(eval sensor == 'xtion')" name="rgb_topic" default="/camera1/rgb/image_rect_color"/>
  <arg if="$(eval sensor == 'kinect')" name="rgb_topic" default="/kinect2/qhd/image_color_rect1"/>
  <arg if="$(eval sensor == 'xtion')" name="depth_topic" default="/camera1/depth_registered/sw_registered/image_rect"/>
  <arg if="$(eval sensor == 'kinect')" name="depth_topic" default="/kinect2/qhd/image_depth_rect1"/>

  <group ns="ccmslam">

    <node pkg="tf" type="static_transform_publisher" name="linkC1_broadcaster" args="0 200 5 -1.571 0 -2 world odomC1 100" />

    <arg name="debug_client" default="false" />
    <arg unless="$(arg debug_client)" name="launch_prefix_client" value=" " />
    <arg if="$(arg debug_client)" name="launch_prefix_client" value="xterm -e gdb --args" />

    <node pkg="ccmslam" type="ccmslamClientNode" name="ccmslamClientNode1" args="$(find ccmslam)/conf/ORBvoc.txt $(arg cam)" output="screen" launch-prefix="$(arg launch_prefix_client)">

      <!-- ++++++++++++++++++++++++++++++++++++++++++++++ -->
      <!-- Agent Specific Params - !!!MUST BE ADJUSTED!!! -->

      <param name="~Sensor" type="string" value="RGBD" />
      <param name="~FrameId" type="string" value="odomC1" />
      <param name="~ClientId" type="int" value="1" />

      <param name="~map_frame_id" type="string" value="map_1" />
      <param name="~camera_frame_id" type="string" value="robot_base_1" />
      <param name="~TopicNameCamSub" type="string" value="$(arg rgb_topic)" />
      <param name="~DepthTopicName" type="string" value="$(arg depth_topic)" />

      <param name="~MapInTopicName" type="string" value="MapOutServer1" unless="$(arg dist)" />
      <param name="~MapInTopicName" type="string" value="MapOutServer1Disturbed" if="$(arg dist)" />

    </node>

  </group>

  <arg if="$(eval sensor == 'xtion')" name="rosbag_path" default="/home/lxy/Datasets/eai-xtion-lab_2020-10-21-10-51-48.bag"/>
  <arg if="$(eval sensor == 'kinect')" name="rosbag_path" default="/home/lxy/Datasets/eai-kinect-lab-short_2020-09-09-15-23-31.bag"/>

  <arg name="rosbag_skip_first_n_sec" default="10" doc="Skip the first n seconds of the rosbag." />
  <node if="$(eval sensor == 'xtion')" name="player1" pkg="rosbag" type="play" output="screen" args="-r 1.0 -s $(arg rosbag_skip_first_n_sec) -q $(arg rosbag_path) /camera/rgb/image_rect_color:=/camera1/rgb/image_rect_color /camera/depth_registered/sw_registered/image_rect:=/camera1/depth_registered/sw_registered/image_rect /tf:=/tf_old" />
  <node if="$(eval sensor == 'kinect')" name="player1" pkg="rosbag" type="play" output="screen" args="-r 1.0 -s $(arg rosbag_skip_first_n_sec) -q $(arg rosbag_path) /kinect2/qhd/image_color_rect/compressed:=/kinect2/qhd/image_color_rect1/compressed /kinect2/qhd/image_depth_rect/compressed:=/kinect2/qhd/image_depth_rect1/compressed /tf:=/tf_old" />

</launch>

